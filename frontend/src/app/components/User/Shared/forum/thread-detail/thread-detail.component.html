<div class="thread-detail-container">
  <!-- Back Button -->
  <div class="back-button">
    <p-button
      [label]="threadDetails?.Forum?.name || 'Back'"
      icon="pi pi-arrow-left"
      class="p-button-text"
      (onClick)="goBack()"
    ></p-button>
  </div>

  <!-- Main Thread Header -->
  <div class="thread-header">
    <div class="flex align-items-center">
      <p-avatar
        [image]="threadDetails?.User.photo"
        size="large"
        shape="circle"
        class="mr-3"
      ></p-avatar>
      <div class="flex-grow-1">
        <div class="flex align-items-center">
          <h5 class="m-0 mr-2">
            {{ threadDetails?.User.firstname || "Anonymous" }}
          </h5>
        </div>
      </div>
    </div>

    <!-- Thread Content -->
    <div class="mt-3">
      <p class="text-lg">
        {{ threadDetails?.content }}
      </p>

      <!-- Thread Media -->
      <div
        *ngIf="
          threadDetails?.attachmentUrls &&
          threadDetails?.attachmentUrls?.length > 0
        "
        class="thread-image"
      >
        <!-- Single Image -->
        <ng-container *ngIf="threadDetails.attachmentUrls.length === 1">
          <p-image
            [src]="getImageUrl(threadDetails.attachmentUrls[0])"
            alt="Thread Media"
            [preview]="true"
            styleClass="w-full border-round-lg"
          ></p-image>
        </ng-container>

        <!-- Multiple Images -->
        <ng-container *ngIf="threadDetails.attachmentUrls.length > 1">
          <div
            [ngClass]="{
              'thread-image-grid': true,
              'thread-image-grid-2': threadDetails.attachmentUrls.length === 2,
              'thread-image-grid-3': threadDetails.attachmentUrls.length >= 3
            }"
          >
            <p-image
              *ngFor="let image of threadDetails.attachmentUrls | slice : 0 : 3"
              [src]="getImageUrl(image)"
              alt="Thread Media"
              [preview]="true"
              styleClass="w-full h-full object-cover"
            ></p-image>

            <!-- Show count for more than 3 images -->
            <div
              *ngIf="threadDetails.attachmentUrls.length > 3"
              class="image-count-overlay"
            >
              +{{ threadDetails.attachmentUrls.length - 3 }}
            </div>
          </div>
        </ng-container>
      </div>

      <!-- Thread Metadata -->
      <div class="flex align-items-center text-secondary mt-3">
        <span class="mr-3">
          {{ threadDetails?.createdAt | date : "mediumTime" }}
        </span>
        <span>
          {{ threadDetails?.createdAt | date : "mediumDate" }}
        </span>
      </div>

      <!-- Interaction Counts -->
      <div class="flex align-items-center mt-3 text-secondary">
        <span class="mr-3">
          <i class="pi pi-comment mr-1"></i>
          {{ posts.length }} Posts
        </span>
        <span>
          <i class="pi pi-heart mr-1"></i>
          {{ threadDetails?.likes || 0 }} Likes
        </span>
      </div>
    </div>
  </div>

  <!-- Interaction Buttons -->
  <div
    class="thread-interactions flex justify-content-between p-3 border-bottom"
  >
    <p-button
      icon="pi pi-comment"
      class="p-button-text p-button-secondary"
      label="Post"
    ></p-button>
    <p-button
      icon="pi pi-heart"
      class="p-button-text p-button-secondary"
      label="Like"
    ></p-button>
    <p-button
      icon="pi pi-share-alt"
      class="p-button-text p-button-secondary"
      label="Repost"
    ></p-button>
  </div>

  <!-- Posts Section -->
  <div class="posts-section">
    <div *ngIf="posts.length > 0; else noPosts">
      <div *ngFor="let post of posts" class="post-item">
        <div class="flex">
          <p-avatar
            [image]="post.User?.photo"
            size="large"
            shape="circle"
            class="mr-3"
          ></p-avatar>
          <div class="flex-grow-1">
            <div class="flex align-items-center">
              <h4 class="m-0 mr-2 text-md">
                {{ post.User?.firstname || "Anonymous" }}
              </h4>
            </div>

            <p class="mt-4 text-md">{{ post.content }}</p>

            <div *ngIf="post.attachments" class="thread-image mt-2">
              <ng-container>
                <p-image
                  [src]="getImageUrl(post.attachments)"
                  alt="Post Attachment"
                  [preview]="true"
                  styleClass="w-full border-round-lg"
                ></p-image>
              </ng-container>
            </div>

            <div class="flex align-items-center text-secondary mt-2">
              <span class="mr-3">
                <i class="pi pi-heart mr-1"></i>
                {{ post.likes || 0 }}
              </span>
              <span>
                {{ post.createdAt | date : "mediumTime" }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <ng-template #noPosts>
      <div class="text-center text-secondary p-4">
        No replies yet. Be the first to respond!
      </div>
    </ng-template>
  </div>

  <!-- New Post Form -->
  <div class="new-post-form">
    <div class="flex">
      <p-avatar
        [image]="userData?.photo"
        size="large"
        shape="circle"
        class="mr-3"
      ></p-avatar>
      <div class="flex-grow-1">
        <textarea
          [(ngModel)]="newPostContent"
          rows="3"
          class="new-post-textarea w-full p-3"
          placeholder="Post your reply..."
        ></textarea>

        <div class="flex align-items-center justify-content-between mt-3">
          <div class="flex align-items-center">
            <input
              type="file"
              accept="image/*"
              (change)="onImageUpload($event)"
              class="hidden"
              #imageInput
            />
            <p-button
              icon="pi pi-image"
              class="p-button-text"
              (onClick)="imageInput.click()"
            ></p-button>

            <span *ngIf="uploadedImageName" class="ml-2 text-secondary text-sm">
              {{ uploadedImageName }}
            </span>
          </div>

          <p-button
            label="Reply"
            icon="pi pi-send"
            class="p-button-primary"
            (onClick)="addPost()"
            [disabled]="!newPostContent.trim() && !uploadedImage"
          ></p-button>
        </div>
      </div>
    </div>
  </div>
</div>

<p-toast></p-toast>
