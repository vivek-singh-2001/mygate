<!-- Back Button -->
<div class="back-button">
  <p-button
    [label]="threadDetails?.Forum?.name || 'Back'"
    icon="pi pi-arrow-left"
    class="p-button-text"
    [text]="true"
    (onClick)="goBack()"
  ></p-button>
</div>

<div class="thread-detail-container">
  <!-- Main Thread Header -->
  <div class="thread-header">
    <div class="flex align-items-center">
      <p-avatar
        [image]="threadDetails?.User.photo"
        size="large"
        shape="circle"
        class="mr-3"
      ></p-avatar>
      <div class="flex-grow-1">
        <div class="flex align-items-center">
          <h5 class="m-0 mr-2">
            {{ threadDetails?.User.firstname || "Anonymous" }}
          </h5>
        </div>
      </div>
    </div>

    <!-- Thread Content -->
    <div class="mt-3">
      <p class="text-lg">
        {{ threadDetails?.content }}
      </p>

      <!-- Thread Media -->
      <div
        *ngIf="
          threadDetails?.attachmentUrls &&
          threadDetails?.attachmentUrls?.length > 0
        "
        class="thread-image"
      >
        <!-- Single Image -->
        <ng-container *ngIf="threadDetails.attachmentUrls.length === 1">
          <p-image
            [src]="getImageUrl(threadDetails.attachmentUrls[0])"
            alt="Thread Media"
            [preview]="true"
            styleClass="w-full border-round-lg"
          ></p-image>
        </ng-container>

        <!-- Multiple Images -->
        <ng-container *ngIf="threadDetails.attachmentUrls.length > 1">
          <div
            [ngClass]="{
              'thread-image-grid': true,
              'thread-image-grid-2': threadDetails.attachmentUrls.length === 2,
              'thread-image-grid-3': threadDetails.attachmentUrls.length >= 3
            }"
          >
            <p-image
              *ngFor="let image of threadDetails.attachmentUrls | slice : 0 : 3"
              [src]="getImageUrl(image)"
              alt="Thread Media"
              [preview]="true"
              styleClass="w-full h-full object-cover"
            ></p-image>

            <!-- Show count for more than 3 images -->
            <div
              *ngIf="threadDetails.attachmentUrls.length > 3"
              class="image-count-overlay"
            >
              +{{ threadDetails.attachmentUrls.length - 3 }}
            </div>
          </div>
        </ng-container>
      </div>

      <!-- Thread Metadata -->
      <div class="flex align-items-center text-secondary mt-3">
        <span class="mr-3">
          {{ threadDetails?.createdAt | date : "mediumTime" }}
        </span>
        <span>
          {{ threadDetails?.createdAt | date : "mediumDate" }}
        </span>
      </div>

      <!-- Interaction Counts -->
      <div class="flex align-items-center mt-3 text-secondary">
        <span class="mr-3">
          <i class="pi pi-comment mr-1"></i>
          {{ posts.length }} Posts
        </span>
        <span>
          <i class="pi pi-heart mr-1"></i>
          {{ threadDetails?.likes || 0 }} Likes
        </span>
      </div>
    </div>
  </div>

  <!-- Interaction Buttons -->
  <!-- <div
    class="thread-interactions flex justify-content-between p-3 border-bottom"
  >
    <p-button
      icon="pi pi-comment"
      class="p-button-text p-button-secondary"
      label="Post"
    ></p-button>
    <p-button
      icon="pi pi-heart"
      class="p-button-text p-button-secondary"
      label="Like"
    ></p-button>
    <p-button
      icon="pi pi-share-alt"
      class="p-button-text p-button-secondary"
      label="Repost"
    ></p-button>
  </div> -->

  <!-- Posts Section -->
  <div class="posts-section">
    <div *ngIf="posts.length > 0; else noPosts">
      <div *ngFor="let post of posts; let i = index" class="post-item">
        <div class="flex">
          <!-- User Avatar -->
          <p-avatar
            [image]="post.User?.photo"
            size="large"
            shape="circle"
            class="mr-3"
          ></p-avatar>
          <div class="flex-grow-1">
            <!-- User Name -->
            <div class="flex align-items-center">
              <h6 class="m-0 mr-2 text-md">
                {{ post.User?.firstname || "Anonymous" }}
              </h6>
            </div>

            <!-- Post Content -->
            <p class="mt-4 text-md">{{ post.content }}</p>

            <!-- Post Attachments -->
            <div *ngIf="post.attachments" class="thread-image mt-2">
              <ng-container>
                <p-image
                  [src]="getImageUrl(post.attachments)"
                  alt="Post Attachment"
                  [preview]="true"
                  styleClass="w-full border-round-lg"
                ></p-image>
              </ng-container>
            </div>

            <!-- Post Metadata and Reply -->
            <div
              class="flex align-items-center justify-content-between text-secondary mt-2"
            >
              <div class="flex align-items-center">
                <span class="mr-3">
                  <i
                    class="pi pi-comment mr-1"
                    (click)="toggleComments(post.id)"
                  ></i>
                  {{ post.replyCount || 0 }}
                </span>
                <span class="mr-3">
                  <i class="pi pi-heart mr-1"></i>
                  {{ post.likes || 0 }}
                </span>
                <span>
                  {{ post.createdAt | date : "mediumTime" }}
                </span>
              </div>
              <!-- Reply Button -->
              <div
                class="flex align-items-center gap-2 reply-action"
                (click)="toggleReplyInput(i)"
              >
                <i class="pi pi-reply mr-1"></i>
                <p class="mr-8">Reply...</p>
              </div>
            </div>

            <div *ngIf="showComments[post.id]" class="comments-container">
              <div
                *ngFor="let comment of comments[post.id]"
                class="comment-item"
              >
                <div class="flex">
                  <!-- Commenter Avatar -->
                  <p-avatar
                    [image]="comment.User?.photo"
                    size="normal"
                    shape="circle"
                    class="mr-3"
                  ></p-avatar>
                  <div class="flex-grow-1">
                    <!-- Commenter Name and Content -->
                    <div class="flex align-items-center">
                      <h5 class="m-0 mr-2">
                        {{ comment.User?.firstname || "Anonymous" }}
                      </h5>
                    </div>
                    <p class="mt-2 text-sm">{{ comment.content }}</p>
                    <!-- Comment Metadata -->
                    <div class="text-secondary mt-1">
                      {{ comment.createdAt | date : "mediumTime" }}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Dynamic Reply Input -->
            <div *ngIf="activeReplyIndex === i" class="reply-input">
              <textarea
                [(ngModel)]="replyContent"
                rows="1"
                class="reply-textarea w-full"
                placeholder="Write a reply..."
              ></textarea>
              <p-button
                icon="pi pi-send"
                class="reply-send-button"
                (onClick)="submitReply(post.id)"
                title="Send reply"
              ></p-button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <ng-template #noPosts>
      <div class="text-center text-secondary p-4">
        No replies yet. Be the first to respond!
      </div>
    </ng-template>
  </div>

  <!-- New Post Form -->
  <div class="new-post-form sticky-bottom">
    <div class="flex align-items-center">
      <!-- User Avatar -->
      <p-avatar
        [image]="userData?.photo"
        size="large"
        shape="circle"
        class="mr-2"
      ></p-avatar>

      <!-- Input Section -->
      <textarea
        [(ngModel)]="newPostContent"
        rows="1"
        class="new-post-textarea flex-grow-1"
        placeholder="Type a message..."
      ></textarea>

      <!-- Image Upload Button -->
      <div class="image-upload-container">
        <input
          type="file"
          accept="image/*"
          (change)="onImageUpload($event)"
          class="hidden"
          #imageInput
        />
        <p-button
          icon="pi pi-paperclip"
          class="p-button-text upload-button"
          (onClick)="imageInput.click()"
          title="Attach an image"
        ></p-button>
      </div>

      <!-- Reply Button -->
      <p-button
        icon="pi pi-send"
        class="p-button-primary reply-button"
        (onClick)="addPost()"
        [disabled]="!newPostContent.trim() && !uploadedImage"
        title="Send message"
      ></p-button>
    </div>
  </div>
</div>

<p-toast></p-toast>
